#!/usr/bin/env bash
set -u
DIR=$(dirname "$(readlink -f "$0")")
FROMTO="$(dirname "$DIR")/bin/fromto"
# shellcheck source=/dev/null
source "$DIR/common"
sudo -k

include_in() {
  DST_FILE="$1"
  LINE_TO_ADD="$2"
  COMMENT_CHAR="$3"
  FULL_LINE="$LINE_TO_ADD $COMMENT_CHAR  Added by holchain"
  if grep --quiet "$FULL_LINE" "$DST_FILE"; then
    echo "  Already exists in $(basename "$DST_FILE")"
  else
    echo "$FULL_LINE" >> "$DST_FILE"
    echo "  Appended config to $(basename "$DST_FILE")"
  fi
}

add_to() {
  DST_FILE="$1"
  FILE_TO_ADD="$2"
  COMMENT_CHAR="$3"
  BEGIN_LINE="$COMMENT_CHAR  Begin holchain block"
  END_LINE="$COMMENT_CHAR  End holchain block"
  if [ ! -e "$DST_FILE" ]; then
    echo "  $DST_FILE does not exist, skipping"
    return
  fi
  grep --quiet "$BEGIN_LINE" "$DST_FILE"
  LINES_NOT_FOUND=$?
  TMPFILE=$(mktemp)
  # shellcheck source=/dev/null
  {
    . "$FROMTO" -vft "$BEGIN_LINE" "$END_LINE" < "$DST_FILE"
    echo "$BEGIN_LINE"
    cat "$FILE_TO_ADD"
    echo "$END_LINE"
  } >> "$TMPFILE"
  cp "$DST_FILE" "$FILE_TO_ADD.backup" || exit 1
  mv "$TMPFILE" "$DST_FILE"
  if [ $LINES_NOT_FOUND -eq 0 ]; then
    echo "  Updated config in $DST_FILE"
  else
    echo "  Added config to $DST_FILE"
  fi
}

write_to() {
  DST_FILE="$1"
  LINE="$2"
  ACTING_USER="$3"
  if [ -f "$DST_FILE" ]; then
    if [ "$LINE" = "$(cat "$DST_FILE")" ]; then
      echo "  $DST_FILE is up to date"
      return
    fi
  fi
  echo "$LINE" | sudo -u "$ACTING_USER" tee "$DST_FILE" > /dev/null
  echo "  Updated $DST_FILE"
}

echo 'adding rc files'
include_in "$BASHRC" "source $DIR/bashrc" "#"
include_in "$PROFILE" "source $DIR/profile" "#"
include_in "$VIMRC" "source $DIR/vimrc" '"'
add_to "$I3CONFIG" "$DIR/i3config" "#"
add_to "$TMUXCONFIG" "$DIR/tmuxconf" "#"

echo 'updating system config'
write_to '/etc/ld.so.conf.d/locallib.conf' '/usr/local/lib' 'root'

echo 'creating directories'
mkdir -p "$HOME/screenshots"
mkdir -p "$HOLCONFIGDIR"
