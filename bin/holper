#!/usr/bin/env bash

function genmsg() {
  if [ $# -eq 0 ]; then
      printf '[]'
      return
  fi
  for arg in "$@"; do
    printf %s\\n "$arg"
  done | jq --raw-input --slurp 'split("\n") | .[0:-1]'
}

socket="/run/user/$UID/holperd.sock"
if [ "$1" = --dev ] || [ "$ISDEV" = 1 ]; then
  socket="/run/user/$UID/holperdev.sock"
  if [ "$1" = --dev ]; then
    shift
  fi
fi

# TODO: this swallows errors in nc
resp=$(genmsg "$@" | nc -U "$socket")
printf %s "$resp" | jq -rc .response | sed s/\\n/\n/
code="$(printf %s "$resp" | jq -rc .code)"
exit "$code"
